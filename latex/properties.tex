In this section we discuss the properties which we want the ledger to have. One
goal is to include these properties in the executable specification for doing
property-based testing or formal verification.

\subsection{Validity of a Ledger State}
\label{sec:valid-ledg-state}

Many properties only make sense when applied to a valid ledger state. In
informal terms, a valid ledger state $l$ can only be reached when starting from
an initial state $l_{0}$ (genesis state) and only executing state transition
rules as specified in Section~\ref{sec:state-trans-utxo-1} for UTxO or
Section~\ref{sec:delegation} for delegation.

\begin{figure}[ht]
  \centering
  \begin{align*}
    \genesisId & \in & \TxId \\
    \genesisTxOut & \in & \TxOut \\
    \genesisUTxO & \coloneqq & \{\genesisId, \emptyset\} \mapsto \genesisTxOut
    \\
    \ledgerState & \in & \left(
                         \begin{array}{c}
                           \UTxO \\
                           \DState \\
                           \PState
                         \end{array}
    \right)\\
    \fun{getUTxO} & \in & \ledgerState \to \UTxO \\
    \fun{getUTxO} & \coloneqq & (\var{utxo}, \wcard, \wcard) \to \var{utxo}
  \end{align*}
  \caption{Valid Ledger State}
  \label{fig:valid-ledger}
\end{figure}

In Figure~\ref{fig:valid-ledger} \genesisId{} marks the transaction identifier
of the initial coin distribution, where \genesisTxOut{} represents the initial
UTxO. It should be noted that no corresponding inputs exists, i.e., the
transaction inputs are the empty set for the initial transaction. An element of
\ledgerState{} is a triplet of UTxO, stake delegation state (\DState) and
delegation pool state (\PState).

\begin{definition}[\textbf{Valid Ledger State}]
  \begin{multline*}
    \label{eq:2}
    \forall l_{0},..,l_{n} \in \ledgerState, l_{0} =
    \left(
      \begin{array}{c}
        \left\{
        \genesisUTxO
        \right\} \\
        \emptyset\\
        \emptyset\\
      \end{array}
    \right)  \\
    \implies \forall 0 < i \leq n, ((\exists c \in \DCert, l_{i-1}
    \trans{delegw}{c} l_{i}) \vee (\exists tx \in \Tx: l_{i-1} \trans{utxow}{tx}
    l_{i}))\\ \implies \applyFun{validLedgerState}(l_{n})
  \end{multline*}
  \label{def:valid-ledger-state}
\end{definition}

Definition~\ref{def:valid-ledger-state} defines a valid ledger state reachable
from the genesis state via valid UTxO, stake delegation or stake pool
transactions. This gives a constructive rule how to reach a valid ledger state.

\subsection{Ledger Properties}
\label{sec:ledger-properties}

The following properties state the desired features of updating a valid ledger
state.

\begin{property}[\textbf{Preserve Balance Modulo Fee}]
  \begin{multline*}
    \forall \var{l}, \var{l'} \in \ledgerState: \applyFun{validLedgerstate}{l}\\
    \implies \forall \var{tx} \in \Tx, \var{l} \trans{utxo}{tx} \var{l'}
    \implies \fun{balance}(\applyFun{getUTxO}{l}) =
    \fun{balance}(\applyFun{getUTxO}{l'}) + \applyFun{txfee}{tx}
  \end{multline*}
  \label{prop:ledger-properties-1}
\end{property}

Property~\ref{prop:ledger-properties-1} states that for each valid ledger $l$,
if a transaction $tx$ is added to the ledger via the state transition rule
$utxow$ to the new ledger state $l'$, the balance of the UTxOs in $l$ equals the
balance of the UTxOs in $l'$ minus the transaction fees.

\begin{property}[\textbf{Preserve Balance Restricted to TxIns in Balance of
    TxOuts}]
  \begin{multline*}
    \forall \var{l}, \var{l'} \in \ledgerState: \applyFun{validLedgerstate}{l}\\
    \implies \forall \var{tx} \in \Tx, \var{l} \trans{utxo}{tx} \var{l'}
    \implies \fun{balance}(\applyFun{txins}{tx} \restrictdom
    \applyFun{getUTxO}{l}) = \fun{balance}(\applyFun{txouts}{tx}) +
    \applyFun{txfee}{tx}
  \end{multline*}
  \label{prop:ledger-properties-2}
\end{property}

Property~\ref{prop:ledger-properties-2} states the more detailed relation of the
balances change. For ledgers $l, l'$ and a transaction $tx$ as above, the
balance of the UTxOs of $l$ restricted to those whose domain is in the set of
transaction inputs of $tx$ equals the balance of the transaction outputs of $tx$
minus the transaction fees.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "ledger-spec"
%%% End:
